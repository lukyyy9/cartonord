# Cartonord Tile Server

High-performance Express.js server for serving vector tiles from MBTiles files generated by the tiler service.

## Overview

The tile server provides fast access to vector tiles stored in MBTiles format. It handles tile requests from web clients, serves metadata, and implements efficient caching strategies for optimal performance. The service directly reads from SQLite databases using optimized queries.

## Features

- **Vector Tile Serving**: Fast serving of Protocol Buffer formatted tiles
- **MBTiles Support**: Direct SQLite database access for tiles
- **Metadata Endpoints**: Tileset information and bounds
- **HTTP Caching**: Optimized cache headers for client-side caching
- **Compression**: Automatic gzip compression for better performance
- **Health Monitoring**: Service status and dependency checks
- **CORS Support**: Cross-origin resource sharing for web clients

## Tech Stack

- **Runtime**: Node.js 18+
- **Framework**: Express.js with compression middleware
- **Database**: SQLite3 for MBTiles file access
- **Compression**: Gzip for tile compression
- **Caching**: HTTP cache control headers
- **Container**: Docker with optimized layers

## Quick Start

### Development

```bash
cd cartonord-tile-server
npm install
npm run dev
```

### Docker

```bash
docker build -t cartonord-tile-server .
docker run -p 3003:3003 -v /data/tilesets:/data/tilesets cartonord-tile-server
```

## Configuration

### Environment Variables

```env
PORT=3003
TILES_DIRECTORY=/data/tilesets
NODE_ENV=production
CACHE_MAX_AGE=3600
COMPRESSION_LEVEL=6
```

### Directory Structure

```txt
/data/tilesets/
├── project-uuid-1.mbtiles
├── project-uuid-2.mbtiles
├── project-uuid-n.mbtiles
└── metadata/
    ├── project-uuid-1.json
    └── project-uuid-2.json
```

## API Endpoints

### Vector Tiles

```http
GET /tiles/{project-id}/{z}/{x}/{y}.pbf
```

Serves vector tiles in Protocol Buffer format.

**Parameters:**

- `project-id`: UUID of the project
- `z`: Zoom level (0-14)
- `x`: Tile column coordinate
- `y`: Tile row coordinate

**Response Headers:**

```http
Content-Type: application/x-protobuf
Content-Encoding: gzip
Cache-Control: public, max-age=3600
ETag: "tile-hash"
```

**Example:**

```bash
curl "http://localhost:3003/tiles/550e8400-e29b-41d4-a716-446655440000/10/512/384.pbf"
```

### Metadata

```http
GET /tiles/{project-id}/metadata
```

Returns tileset metadata and configuration.

**Response:**

```json
{
  "name": "Project Name",
  "format": "pbf",
  "bounds": [-180, -85.0511, 180, 85.0511],
  "center": [2.3522, 48.8566, 10],
  "minzoom": 0,
  "maxzoom": 14,
  "attribution": "© Cartonord",
  "description": "Project description",
  "version": "1.0.0"
}
```

### Project Listing

```http
GET /projects
```

Lists available projects with basic information.

**Response:**

```json
{
  "projects": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "Project Name",
      "lastModified": "2024-01-15T10:30:00Z",
      "fileSize": 2048576,
      "bounds": [-180, -85.0511, 180, 85.0511]
    }
  ]
}
```

### Health Check

```http
GET /health
```

Returns service health status.

**Response:**

```json
{
  "status": "healthy",
  "service": "cartonord-tile-server",
  "timestamp": "2024-01-15T10:30:00Z",
  "uptime": 3600,
  "version": "1.0.0"
}
```

## MBTiles Format

### Database Schema

MBTiles files are SQLite databases with standardized tables:

```sql
-- Tiles data table
CREATE TABLE tiles (
    zoom_level INTEGER,
    tile_column INTEGER,
    tile_row INTEGER,
    tile_data BLOB,
    PRIMARY KEY (zoom_level, tile_column, tile_row)
);

-- Metadata table
CREATE TABLE metadata (
    name TEXT,
    value TEXT,
    PRIMARY KEY (name)
);

-- Spatial index
CREATE INDEX tiles_index ON tiles (zoom_level, tile_column, tile_row);
```

### Coordinate System Conversion

The service automatically converts between coordinate systems:

- **Input**: TMS (Tile Map Service) coordinates from MBTiles
- **Output**: XYZ (Google/OSM) coordinates for web clients

```javascript
// TMS to XYZ Y-coordinate conversion
const xyzY = (1 << zoom) - 1 - tmsY;
```

## MapLibre Integration

### Style Configuration

```javascript
const mapStyle = {
  version: 8,
  sources: {
    'cartonord-tiles': {
      type: 'vector',
      tiles: ['http://localhost:3003/tiles/{project-id}/{z}/{x}/{y}.pbf'],
      minzoom: 0,
      maxzoom: 14
    }
  },
  layers: [
    {
      id: 'layer-name',
      type: 'fill',
      source: 'cartonord-tiles',
      'source-layer': 'layer-name',
      paint: {
        'fill-color': '#3388ff',
        'fill-opacity': 0.7
      }
    }
  ]
};
```

### Map Initialization

```javascript
import maplibregl from 'maplibre-gl';

const map = new maplibregl.Map({
  container: 'map',
  style: mapStyle,
  center: [2.3522, 48.8566],
  zoom: 10
});

// Add navigation controls
map.addControl(new maplibregl.NavigationControl());
```

## Performance Optimization

### Caching Strategy

```javascript
// Cache headers for optimal performance
app.use('/tiles', (req, res, next) => {
  res.set({
    'Cache-Control': 'public, max-age=3600',
    'ETag': generateETag(req.params),
    'Vary': 'Accept-Encoding'
  });
  next();
});
```

### Database Optimization

```javascript
// Optimized SQLite query for tile retrieval
const getTile = (zoom, x, y) => {
  return new Promise((resolve, reject) => {
    const query = `
      SELECT tile_data 
      FROM tiles 
      WHERE zoom_level = ? AND tile_column = ? AND tile_row = ?
    `;
    
    db.get(query, [zoom, x, y], (err, row) => {
      if (err) reject(err);
      else resolve(row?.tile_data);
    });
  });
};
```

### Compression

- **Gzip**: Automatic compression for text responses
- **Brotli**: Optional Brotli compression for better ratios
- **Pre-compressed**: Static file pre-compression

## Monitoring

### Metrics

Track important performance indicators:

```javascript
const metrics = {
  requestsPerSecond: 0,
  averageResponseTime: 0,
  cacheHitRatio: 0,
  errorRate: 0,
  activeConnections: 0
};
```

### Logging

Structured logging for operational insights:

```javascript
logger.info('Tile request', {
  project: projectId,
  zoom: z,
  coordinates: { x, y },
  responseTime: Date.now() - startTime,
  cacheHit: cacheHit,
  clientIP: req.ip
});
```

## Error Handling

### Common Error Responses

```javascript
// Tile not found
{
  "error": "Tile not found",
  "code": "TILE_NOT_FOUND",
  "project": "project-id",
  "coordinates": { "z": 10, "x": 512, "y": 384 }
}

// Project not found
{
  "error": "Project not found",
  "code": "PROJECT_NOT_FOUND",
  "project": "invalid-project-id"
}

// Invalid coordinates
{
  "error": "Invalid tile coordinates",
  "code": "INVALID_COORDINATES",
  "coordinates": { "z": "invalid", "x": "invalid", "y": "invalid" }
}
```

## Development

### Running Tests

```bash
npm test                    # Run test suite
npm run test:integration   # Integration tests
npm run test:performance   # Performance benchmarks
```

### Debugging

```bash
DEBUG=cartonord-tile-server:* npm run dev
```

## Security

- **Input Validation**: Coordinate and project ID validation
- **Path Traversal Protection**: Secure file access
- **Rate Limiting**: Request throttling for abuse prevention
- **CORS Configuration**: Controlled cross-origin access

## Future Enhancements

- **PMTiles Support**: Next-generation tile format
- **Redis Caching**: Distributed tile caching
- **CDN Integration**: Content delivery network support
- **Tile Compression**: Advanced compression algorithms
- **Real-time Updates**: WebSocket-based tile updates
