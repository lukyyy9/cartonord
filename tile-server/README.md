# Cartonord Tile Server

High-performance Express.js server for serving vector tiles from MBTiles files generated by the tiler service.

## Overview

The tile server provides fast access to vector tiles stored in MBTiles format. It handles tile requests from web clients, serves metadata, and implements efficient caching strategies for optimal performance. The service directly reads from SQLite databases using optimized queries.

## Features

- **Vector Tile Serving**: Fast serving of Protocol Buffer formatted tiles
- **MBTiles Support**: Direct SQLite database access for tiles
- **Metadata Endpoints**: Tileset information and bounds
- **HTTP Caching**: Optimized cache headers for client-side caching
- **Compression**: Automatic gzip compression for better performance
- **Health Monitoring**: Service status and dependency checks
- **CORS Support**: Cross-origin resource sharing for web clients

## Tech Stack

- **Runtime**: Node.js 21.11.0
- **Framework**: Express.js with compression middleware
- **Database**: SQLite3 for MBTiles file access
- **Compression**: Gzip for tile compression
- **Caching**: HTTP cache control headers
- **Container**: Docker with optimized layers

## Quick Start

### Development

```bash
cd tile-server
npm install
npm run dev
```

### Docker

```bash
docker build -t tile-server .
docker run -p 3003:3003 -v /data/tilesets:/data/tilesets tile-server
```

## Configuration

### Environment Variables

```env
PORT=3003
TILES_DIRECTORY=/data/tilesets
NODE_ENV=production
CACHE_MAX_AGE=3600
COMPRESSION_LEVEL=6
```

### Directory Structure

```txt
/data/tilesets/
├── project-uuid-1.mbtiles
├── project-uuid-2.mbtiles
├── project-uuid-n.mbtiles
└── metadata/
    ├── project-uuid-1.json
    └── project-uuid-2.json
```

## API Endpoints

### Vector Tiles

```http
GET /tiles/{project-id}/{z}/{x}/{y}.pbf
```

Serves vector tiles in Protocol Buffer format.

**Parameters:**

- `project-id`: UUID of the project/map
- `z`: Zoom level (0-18)
- `x`: Tile column coordinate
- `y`: Tile row coordinate

**Response Headers:**

```http
Content-Type: application/x-protobuf
Content-Encoding: gzip
Cache-Control: public, max-age=3600
ETag: "tile-hash"
```

**Example:**

```bash
curl "http://localhost:3003/tiles/550e8400-e29b-41d4-a716-446655440000/10/512/384.pbf"
```

### Metadata

```http
GET /tiles/{project-id}/metadata
```

Returns tileset metadata and configuration.

**Response:**

```json
{
  "name": "Map Name",
  "format": "pbf",
  "bounds": [-180, -85.0511, 180, 85.0511],
  "center": [2.3522, 48.8566, 10],
  "minzoom": 0,
  "maxzoom": 18,
  "attribution": "© Cartonord",
  "description": "Map description",
  "version": "1.0.0"
}
```

### Project Listing

```http
GET /projects
```

Lists available projects with basic information.

**Response:**

```json
{
  "projects": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "Map Name",
      "lastModified": "2024-01-15T10:30:00Z",
      "fileSize": 2048576,
      "bounds": [-180, -85.0511, 180, 85.0511]
    }
  ]
}
```

### Health Check

```http
GET /health
```

Returns service health status.

**Response:**

```json
{
  "status": "healthy",
  "service": "tile-server",
  "timestamp": "2024-01-15T10:30:00Z",
  "uptime": 3600,
  "version": "1.0.0"
}
```

## MBTiles Format

### Database Schema

MBTiles files are SQLite databases with standardized tables:

```sql
-- Tiles data table
CREATE TABLE tiles (
    zoom_level INTEGER,
    tile_column INTEGER,
    tile_row INTEGER,
    tile_data BLOB,
    PRIMARY KEY (zoom_level, tile_column, tile_row)
);

-- Metadata table
CREATE TABLE metadata (
    name TEXT,
    value TEXT,
    PRIMARY KEY (name)
);

-- Spatial index
CREATE INDEX tiles_index ON tiles (zoom_level, tile_column, tile_row);
```

### Coordinate System Conversion

The service automatically converts between coordinate systems:

- **Input**: TMS (Tile Map Service) coordinates from MBTiles
- **Output**: XYZ (Google/OSM) coordinates for web clients

```javascript
// TMS to XYZ Y-coordinate conversion
const xyzY = (1 << zoom) - 1 - tmsY;
```

## MapLibre Integration

### Style Configuration

```javascript
const mapStyle = {
  version: 8,
  sources: {
    'cartonord-tiles': {
      type: 'vector',
      tiles: ['http://localhost:3003/tiles/{map-id}/{z}/{x}/{y}.pbf'],
      minzoom: 0,
      maxzoom: 18
    }
  },
  layers: [
    {
      id: 'polygon-layer',
      type: 'fill',
      source: 'cartonord-tiles',
      'source-layer': 'map-{map-id}',
      filter: ['==', '$type', 'Polygon'],
      paint: {
        'fill-color': ['get', 'color'],
        'fill-opacity': ['get', 'opacity']
      }
    },
    {
      id: 'line-layer',
      type: 'line',
      source: 'cartonord-tiles',
      'source-layer': 'map-{map-id}',
      filter: ['==', '$type', 'LineString'],
      paint: {
        'line-color': ['get', 'color'],
        'line-width': 2,
        'line-opacity': ['get', 'opacity']
      }
    },
    {
      id: 'point-layer',
      type: 'circle',
      source: 'cartonord-tiles',
      'source-layer': 'map-{map-id}',
      filter: ['==', '$type', 'Point'],
      paint: {
        'circle-color': ['get', 'color'],
        'circle-radius': 5,
        'circle-opacity': ['get', 'opacity']
      }
    }
  ]
};
```

### Map Initialization

```javascript
import maplibregl from 'maplibre-gl';

const map = new maplibregl.Map({
  container: 'map',
  style: mapStyle,
  center: [2.3522, 48.8566],
  zoom: 10
});

// Add navigation controls
map.addControl(new maplibregl.NavigationControl());
```

## Performance Optimization

### Caching Strategy

```javascript
// Cache headers for optimal performance
app.use('/tiles', (req, res, next) => {
  res.set({
    'Cache-Control': 'public, max-age=3600',
    'ETag': generateETag(req.params),
    'Vary': 'Accept-Encoding'
  });
  next();
});
```

### Database Optimization

The [`TileService`](src/services/TileService.js) provides optimized SQLite queries:

```javascript
// Optimized tile retrieval
const getTile = (projectId, zoom, x, y) => {
  return new Promise((resolve, reject) => {
    const mbtilesPath = path.join(this.tilesDirectory, `${projectId}.mbtiles`);
    const db = new sqlite3.Database(mbtilesPath, sqlite3.OPEN_READONLY);
    
    const query = `
      SELECT tile_data 
      FROM tiles 
      WHERE zoom_level = ? AND tile_column = ? AND tile_row = ?
    `;
    
    db.get(query, [zoom, x, y], (err, row) => {
      db.close();
      if (err) reject(err);
      else resolve(row?.tile_data);
    });
  });
};
```

### Compression

- **Gzip**: Automatic compression for tile responses
- **Content-Encoding**: Proper headers for client decompression
- **Tile Optimization**: Pre-compressed tiles in MBTiles format

## Service Integration

### Backend Integration

The tile server integrates seamlessly with the Cartonord backend:

- **Map Publishing**: Tiles are served for published maps only
- **Dynamic Routing**: Map IDs correspond to backend map entities
- **Metadata Sync**: Tileset metadata reflects map configuration

### Frontend Integration

The frontend [`MapViewer`](../front/src/user/MapViewer.jsx) and [`MapEditor`](../front/src/admin/MapEditor.jsx) consume tiles:

```javascript
// Public map viewer configuration
const TILE_SERVER_URL = 'http://localhost:3003';
const tileSource = `${TILE_SERVER_URL}/tiles/${mapData.id}/{z}/{x}/{y}.pbf`;
```

## Monitoring

### Health Checks

The [`HealthService`](src/services/HealthService.js) provides comprehensive monitoring:

- **Tile Directory**: Verification of tiles directory existence and permissions
- **Database Access**: SQLite database connectivity checks
- **File System**: Available disk space and read permissions

### Logging

Structured logging for operational insights:

```javascript
logger.info('Tile served', {
  projectId,
  zoom: z,
  coordinates: { x, y },
  responseTime: Date.now() - startTime,
  tileSize: tileData?.length || 0,
  clientIP: req.ip
});
```

## Error Handling

### Common Error Responses

```javascript
// Tile not found (404)
{
  "error": "Tile not found",
  "projectId": "project-id",
  "coordinates": { "z": 10, "x": 512, "y": 384 }
}

// Project not found (404)
{
  "error": "Project not found",
  "projectId": "invalid-project-id"
}

// Invalid coordinates (400)
{
  "error": "Invalid tile coordinates",
  "message": "Coordinates must be valid integers"
}

// Internal server error (500)
{
  "error": "Database error",
  "message": "Failed to read MBTiles file"
}
```

## File Structure

```
src/
├── index.js                 # Express application entry point
├── routes/
│   ├── tiles.js            # Tile serving endpoints
│   ├── projects.js         # Project listing endpoints
│   └── health.js           # Health check endpoints
├── services/
│   ├── TileService.js      # Core tile serving logic
│   └── HealthService.js    # Health monitoring service
├── middlewares/
│   ├── caching.js          # Cache control middleware
│   ├── logging.js          # Request logging
│   └── errorHandler.js     # Error handling
└── utils/
    └── logger.js           # Winston logger configuration
```

## Development

### Running Tests

```bash
npm test                    # Run test suite
npm run test:integration   # Integration tests with MBTiles
npm run test:performance   # Performance benchmarks
```

### Debugging

```bash
DEBUG=tile-server:* npm run dev
```

### Mock Development

For development without MBTiles files:

```javascript
// Set environment variable for mock responses
MOCK_TILES=true npm run dev
```

## Security

- **Input Validation**: Coordinate and project ID validation
- **Path Traversal Protection**: Secure file access with path validation
- **Rate Limiting**: Request throttling for abuse prevention
- **CORS Configuration**: Controlled cross-origin access
- **File Access Control**: Restricted access to tiles directory only

## Production Deployment

### Environment Setup

1. Configure tiles directory permissions
2. Set appropriate cache headers
3. Enable compression
4. Configure monitoring and logging
5. Set up health check endpoints

### Health Checks

The service provides health endpoints for container orchestration:

- `/health` - Basic liveness check
- Health monitoring includes tiles directory and database access verification

## Performance Considerations

- **Connection Pooling**: Efficient SQLite connection management
- **Memory Usage**: Optimized tile streaming for large files
- **Disk I/O**: Efficient file system operations
- **Network**: Optimized response headers and compression

## Future Enhancements

- **PMTiles Support**: Next-generation tile format support
- **Redis Caching**: Distributed tile caching layer
- **CDN Integration**: Content delivery network compatibility
- **Tile Streaming**: Progressive tile loading
- **Real-time Updates**: WebSocket-based tile invalidation